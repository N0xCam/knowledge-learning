<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="icon" type="image/png" href="/images/favicon.png">
</head>
<body>
  <!-- Navbar -->
  <nav>
    <ul>
      <li><a href="/">Accueil</a></li>

      <% if (!session.user) { %>
        <li><a href="/auth/register">S'inscrire</a></li>
        <li><a href="/auth/login">Se connecter</a></li>
      <% } else { %>
        <li><a href="/client/themes">Th√®mes</a></li>
        <li><a href="/client/certifications">Mes certifications</a></li>

        <% if (session.user.role === 'admin') { %>
          <li><a href="/admin/dashboard">Dashboard</a></li>
        <% } %>

        <li>
          <form method="POST" action="/auth/logout" style="display:inline;">
            <button>D√©connexion</button>
          </form>
        </li>
      <% } %>
    </ul>
  </nav>
  
  <h1>Tableau de bord administrateur</h1>

<!-- USERS -->
<section>
  <h2>Utilisateurs</h2>

  <form action="/admin/users/create" method="POST">
    <input type="text" name="name" placeholder="Nom" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="password" name="password" placeholder="Mot de passe" required>
    <select name="role" required>
      <option value="client">Client</option>
      <option value="admin">Admin</option>
      <option value="autre">Autre</option>
    </select>
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <button type="submit">Ajouter</button>
  </form>

  <table id="users-table">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Email</th>
        <th>R√¥le</th>
        <th>Actif</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% users.forEach(user => { %>
        <tr id="user-<%= user._id %>">
          <form action="/admin/users/<%= user._id %>/update" method="POST">
            <td><input type="text" name="name" value="<%= user.name %>" required></td>
            <td><input type="email" name="email" value="<%= user.email %>" required></td>
            <td>
              <select name="role">
                <option value="client" <%= user.role === 'client' ? 'selected' : '' %>>Client</option>
                <option value="admin" <%= user.role === 'admin' ? 'selected' : '' %>>Admin</option>
                <option value="autre" <%= user.role === 'autre' ? 'selected' : '' %>>Autre</option>
              </select>
            </td>
            <td>
              <input type="checkbox" name="isActive" value="true" <%= user.isActive ? 'checked' : '' %>>
            </td>
            <td>
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit">‚úèÔ∏è</button>
          </form>
              <form action="/admin/users/<%= user._id %>/delete" method="POST" style="display:inline;">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit">üóë</button>
              </form>
            </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</section>



  <!-- THEMES -->
  <section>
    <h2>Th√®mes</h2>
    <form action="/admin/themes/create" method="POST">
  <input type="text" name="title" required> 
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <button type="submit">Ajouter</button>
</form>


<table id="themes-table">
  <thead>
    <tr><th>Titre</th><th>Actions</th></tr>
  </thead>
  <tbody>
    <% themes.forEach(theme => { %>
      <tr id="theme-<%= theme._id %>">
        <td>
          <input type="text" value="<%= theme.title %>" id="input-theme-<%= theme._id %>">
        </td>
        <td>
          <button type="button" onclick="modifierTheme('<%= theme._id %>')">‚úèÔ∏è</button>
          <form action="/admin/themes/<%= theme._id %>/delete" method="POST" style="display:inline;">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button type="submit">üóë</button>
          </form>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>


  <!-- CURSUS -->
  <section>
    <h2>Cursus</h2>
    <form action="/admin/cursus/create" method="POST">
      <input type="text" name="title" placeholder="Titre du cursus" required>
      <input type="number" name="price" placeholder="Prix" required>
      <select name="theme" required>
        <% themes.forEach(theme => { %>
          <option value="<%= theme._id %>"><%= theme.title %></option>
        <% }) %>
      </select>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="submit">Ajouter</button>
    </form>

    <table id="cursus-table">
      <thead><tr><th>Titre</th><th>Prix</th><th>Th√®me</th><th>Actions</th></tr></thead>
      <tbody>
        <% cursus.forEach(c => { %>
          <tr id="cursus-<%= c._id %>">
            <td><input type="text" value="<%= c.title %>" id="input-cursus-title-<%= c._id %>"></td>
            <td><input type="number" value="<%= c.price %>" id="input-cursus-price-<%= c._id %>"></td>
            <td><%= c.theme?.title || '‚õî' %></td>
            <td>
  <button type="button" onclick="modifierCursus('<%= c._id %>')">‚úèÔ∏è</button>
  <form action="/admin/cursus/<%= c._id %>/delete" method="POST" style="display:inline;">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <button type="submit">üóë</button>
  </form>
</td>

          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- LESSONS -->
  <section>
    <h2>Le√ßons</h2>
    <form action="/admin/lessons/create" method="POST">
      <input type="text" name="title" placeholder="Titre de la le√ßon" required>
      <input type="number" name="price" placeholder="Prix" required>
      <select name="cursus" required>
        <% cursus.forEach(c => { %>
          <option value="<%= c._id %>"><%= c.title %></option>
        <% }) %>
      </select>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="submit">Ajouter</button>
    </form>

    <table id="lessons-table">
      <thead><tr><th>Titre</th><th>Prix</th><th>Cursus</th><th>Actions</th></tr></thead>
      <tbody>
        <% lessons.forEach(l => { %>
          <tr id="lesson-<%= l._id %>">
            <td><input type="text" value="<%= l.title %>" id="input-lesson-title-<%= l._id %>"></td>
            <td><input type="number" value="<%= l.price %>" id="input-lesson-price-<%= l._id %>"></td>
            <td><%= l.cursus?.title || '‚õî' %></td>
           <td>
  <button type="button" onclick="modifierLesson('<%= l._id %>')">‚úèÔ∏è</button>
  <form action="/admin/lessons/<%= l._id %>/delete" method="POST" style="display:inline;">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <button type="submit">üóë</button>
  </form>
</td>

          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- SCRIPT INLINE -->
  <script>
    const csrf = '<%= csrfToken %>';

    document.querySelectorAll('.ajax-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const type = form.dataset.type;

        const res = await fetch(form.action, {
          method: 'POST',
          headers: { 'CSRF-Token': csrf },
          body: formData
        });

        const data = await res.json();
        if (!res.ok) return alert(data.message || 'Erreur');
        location.reload();
      });
    });

    async function modifierTheme(id) {
      const title = document.getElementById(`input-theme-${id}`).value;
      const res = await fetch(`/admin/themes/${id}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
        body: JSON.stringify({ title })
      });
      if (!res.ok) alert('Erreur lors de la modification du th√®me');
    }

    async function modifierCursus(id) {
      const title = document.getElementById(`input-cursus-title-${id}`).value;
      const price = document.getElementById(`input-cursus-price-${id}`).value;
      const res = await fetch(`/admin/cursus/${id}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
        body: JSON.stringify({ title, price })
      });
      if (!res.ok) alert('Erreur lors de la modification du cursus');
    }

    async function modifierLesson(id) {
      const title = document.getElementById(`input-lesson-title-${id}`).value;
      const price = document.getElementById(`input-lesson-price-${id}`).value;
      const res = await fetch(`/admin/lessons/${id}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
        body: JSON.stringify({ title, price })
      });
      if (!res.ok) alert('Erreur lors de la modification de la le√ßon');
    }
  </script>
</body>
</html>
